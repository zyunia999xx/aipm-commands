# 04 ä»®èª¬é§†å‹•: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—ï¼ˆAIPMãƒãƒƒã‚«ã‚½ãƒ³ï¼‰

## æœ€åˆã«è³ªå•ï¼ˆå®Ÿè¡Œå‰ã«å›ç­”ã—ã¦ãã ã•ã„ï¼‰
- ãƒšãƒ«ã‚½ãƒŠï¼ˆæ—¢å®š: P001ï¼‰ï¼ˆå¿…é ˆï¼‰
- PR1/PR2/PR3 ãã‚Œãã‚Œã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆAs a / I want / So thatï¼‰ï¼ˆå¿…é ˆï¼‰
- å„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®å—ã‘å…¥ã‚ŒåŸºæº–ï¼ˆå¿…é ˆï¼‰
- ãƒªãƒªãƒ¼ã‚¹åŒºåˆ†ï¼ˆMVP or Release1ï¼‰ï¼ˆå¿…é ˆï¼‰
- å®Ÿè£…é †åºï¼ˆä»»æ„ï¼‰

## ç›®çš„
Problemï¼ˆPRï¼‰ã¨Solutionï¼ˆSLï¼‰ã«é€£å‹•ã—ã€è¡Œå‹•ï¼ˆAï¼‰ã‹ã‚‰æ´¾ç”Ÿã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆSTï¼‰ã‚’Aâ†’PRâ†’SLâ†’STã®æµã‚Œã§å¯è¦–åŒ–ã—ã¾ã™ã€‚

## å®Ÿè¡Œæ‰‹é †
```yaml
- trigger: "(ä»®èª¬é§†å‹•_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—|HypothesisStoryMap)"
  priority: high
  steps:
    - name: "infer_defaults_from_thread"
      action: "analyze"
      data: ["{{thread_messages}}", "{{read_files(find_files(patterns=['**/solution_map.yaml','**/problem_map.yaml','**/customer_problem_map.yaml']))}}"]
      instructions: |
        ç›´è¿‘ã®PR/SL/Activityå¯¾å¿œã‹ã‚‰ã€PRâ†’SLâ†’STã®åˆæœŸãƒã‚§ãƒ¼ãƒ³ï¼ˆST1/2/3ï¼‰ã‚’æ¨å®šã—ã¦è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
      store_as: "auto_story_hints"

    - name: "ingest_sense_focus"
      action: "analyze"
      data: [
        "{{read_files(find_files(patterns=['**/1_sense/07_ã‚ªãƒãƒãƒ¥ãƒ‹ãƒ†ã‚£ä»®èª¬æŠ½å‡º/sense_opportunities.yaml']))}}",
        "{{read_files(find_files(patterns=['**/1_sense/06_ãƒªã‚µãƒ¼ãƒã‚µãƒãƒªãƒ¼ï¼ˆå…¨ä½“ï¼‰/draft_research_summary.md']))}}",
        "{{read_files(find_files(patterns=['**/focus_product_definition.md','**/focus_positioning_statement.md']))}}",
        "{{read_files(find_files(patterns=['**/1_sense/02_é¡§å®¢èª¿æŸ»/sense_customer_research.md']))}}",
        "{{read_files(find_files(patterns=['**/03_ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ—/solution_map.yaml']))}}"
      ]
      instructions: |
        Sense/Focusã¨ç¢ºå®šæ¸ˆã¿ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã€PRâ†’SLâ†’STã®å€™è£œã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆAs/I want/So thatï¼‰ã€å—ã‘å…¥ã‚ŒåŸºæº–ã®é››å½¢ã€æ¨å¥¨ãƒªãƒªãƒ¼ã‚¹ï¼ˆMVP/Release1ï¼‰ã‚’æŠ½å‡ºã—ã€JSON1ä»¶ã§è¿”ã—ã¦ãã ã•ã„ã€‚
        keys:
          st1_summary_hint, st1_ac_hint, st1_release_hint,
          st2_summary_hint, st2_ac_hint, st2_release_hint,
          st3_summary_hint, st3_ac_hint, st3_release_hint
      store_as: "sense_focus"
    - name: "prefill_from_yaml"
      action: "display"
      content: |
        ğŸ” å€™è£œï¼ˆè‡ªå‹•æŠ½å‡ºï¼‰
        {{auto_story_hints}}
        
        ğŸ” Sense/Focus ç”±æ¥ã®å€™è£œ
        - ST1: {{sense_focus.st1_summary_hint}} / AC: {{sense_focus.st1_ac_hint}} / ãƒªãƒªãƒ¼ã‚¹: {{sense_focus.st1_release_hint}}
        - ST2: {{sense_focus.st2_summary_hint}} / AC: {{sense_focus.st2_ac_hint}} / ãƒªãƒªãƒ¼ã‚¹: {{sense_focus.st2_release_hint}}
        - ST3: {{sense_focus.st3_summary_hint}} / AC: {{sense_focus.st3_ac_hint}} / ãƒªãƒªãƒ¼ã‚¹: {{sense_focus.st3_release_hint}}
    
    - name: "show_story_examples"
      action: "display"
      content: |
        ğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ›¸å¼
        As a [èª°ãŒ], I want [ä½•ã‚’ã—ãŸã„], So that [ãªãœ/ä¾¡å€¤]
        ä¾‹: As a å…±åƒããƒãƒ, I want ã€Œä»Šã‚„ã‚‹1ã¤ã€ã ã‘ã‚’è¦‹ã‚‹, So that è¿·ã‚ãšç€æ‰‹ã§ãã‚‹
    
    - name: "collect_story_inputs"
      action: "ask_questions_with_template"
      template: |
        === PRé€£å‹•ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å…¥åŠ›ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ===
        1) PR1 â†’ ST1
        - ST1ï¼ˆAs/I want/So thatï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st1_summary_hint}}ï¼‰
        â†’
        - å—ã‘å…¥ã‚ŒåŸºæº–ï¼ˆç®‡æ¡æ›¸ãï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st1_ac_hint}}ï¼‰
        â†’
        - ãƒªãƒªãƒ¼ã‚¹ï¼ˆMVP/Release1ï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st1_release_hint}}ï¼‰
        â†’
        
        2) PR2 â†’ ST2
        - ST2ï¼ˆAs/I want/So thatï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st2_summary_hint}}ï¼‰
        â†’
        - å—ã‘å…¥ã‚ŒåŸºæº–
        ï¼ˆå€™è£œ: {{sense_focus.st2_ac_hint}}ï¼‰
        â†’
        - ãƒªãƒªãƒ¼ã‚¹ï¼ˆMVP/Release1ï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st2_release_hint}}ï¼‰
        â†’
        
        3) PR3 â†’ ST3
        - ST3ï¼ˆAs/I want/So thatï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st3_summary_hint}}ï¼‰
        â†’
        - å—ã‘å…¥ã‚ŒåŸºæº–
        ï¼ˆå€™è£œ: {{sense_focus.st3_ac_hint}}ï¼‰
        â†’
        - ãƒªãƒªãƒ¼ã‚¹ï¼ˆMVP/Release1ï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st3_release_hint}}ï¼‰
        â†’
        
        4) å®Ÿè£…é †åºï¼ˆä»»æ„ã€‚ä¾‹: ST1â†’ST2â†’ST3ï¼‰
        â†’
        =====================================
    
    - name: "wait_inputs"
      action: "wait_for_all_answers"
    
    # ã“ã“ã‹ã‚‰ï¼šè‡ªå‹•ææ¡ˆï¼ˆAâ†’PRâ†’SLâ†’STï¼‰ â†’ ä¿®æ­£åé›† â†’ ç¢ºå®šç”Ÿæˆ
    - name: "auto_propose_story_map_yaml"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_proposed.yaml"
      content: |
        story_map:
          persona_ref: {{persona_id | default:"P001"}}
          problem_refs: [PR1, PR2, PR3]
          links:
            - chain: [A101, PR1, SL1, ST1]
            - chain: [A201, PR2, SL2, ST2]
            - chain: [A301, PR3, SL3, ST3]
          stories:
            - id: ST1
              summary: {{st1_summary}}
              acceptance: [{{st1_ac_1}}, {{st1_ac_2}}, {{st1_ac_3}}]
              release: {{st1_release | default:"MVP"}}
              links: [PR1, SL1, A101]
            - id: ST2
              summary: {{st2_summary}}
              acceptance: [{{st2_ac_1}}, {{st2_ac_2}}, {{st2_ac_3}}]
              release: {{st2_release | default:"MVP"}}
              links: [PR2, SL2, A201]
            - id: ST3
              summary: {{st3_summary}}
              acceptance: [{{st3_ac_1}}, {{st3_ac_2}}, {{st3_ac_3}}]
              release: {{st3_release | default:"Release1"}}
              links: [PR3, SL3, A301]
          releases:
            - name: MVP
              includes: [ST1, ST2]
            - name: Release1
              includes: [ST3]
          numbering_policy:
            - prefix: ST=Story
    
    - name: "auto_propose_story_map_mermaid"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_proposed_mermaid.md"
      content: |
        ```mermaid
        flowchart LR
          A101:::action --> PR1:::problem --> SL1:::solution --> ST1[ST1]:::story
          A201:::action --> PR2:::problem --> SL2:::solution --> ST2[ST2]:::story
          A301:::action --> PR3:::problem --> SL3:::solution --> ST3[ST3]:::story
          classDef action fill:#fff3e0
          classDef problem fill:#ffebee
          classDef solution fill:#e8f5e8
          classDef story fill:#e3f2fd
        ```
    
    - name: "display_proposal"
      action: "display"
      content: |
        âœï¸ è‡ªå‹•ææ¡ˆã‚’ `story_map_proposed.yaml` / `story_map_proposed_mermaid.md` ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚ä¿®æ­£äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯æ¡ç”¨ï¼‰ã€‚
    
    - name: "collect_story_corrections"
      action: "ask_questions_with_template"
      template: |
        === ä¿®æ­£ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆç©ºæ¬„ã¯æ¡ç”¨ï¼‰ ===
        ST1 è¦ç´„/AC/ãƒªãƒªãƒ¼ã‚¹/ãƒªãƒ³ã‚¯ï¼ˆä¾‹: PR1,SL1,A101ï¼‰
        â†’
        ST2 è¦ç´„/AC/ãƒªãƒªãƒ¼ã‚¹/ãƒªãƒ³ã‚¯
        â†’
        ST3 è¦ç´„/AC/ãƒªãƒªãƒ¼ã‚¹/ãƒªãƒ³ã‚¯
        â†’
        å®Ÿè£…é †åºï¼ˆä»»æ„ï¼‰ï¼š
        â†’
        =====================================
    
    - name: "confirm_generate"
      action: "confirm"
      message: "ææ¡ˆï¼‹ä¿®æ­£å†…å®¹ã§æœ€çµ‚æˆæœç‰©ï¼ˆstory_map_todo.md / story_map.yaml / story_map_mermaid.mdï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
    
    - name: "generate_story_map_md"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_todo.md"
      content: |
        # ã‚¢ãƒ—ãƒª MVPã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—
        
        ## å„ªå…ˆåº¦é †ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆPRé€£å‹•ï¼‰
        1. {{st1_summary}}ï¼ˆå—ã‘å…¥ã‚ŒåŸºæº–: {{st1_ac_1}} / {{st1_ac_2}} / {{st1_ac_3}}ã€ãƒªãƒªãƒ¼ã‚¹: {{st1_release | default:"MVP"}}ï¼‰
        2. {{st2_summary}}ï¼ˆå—ã‘å…¥ã‚ŒåŸºæº–: {{st2_ac_1}} / {{st2_ac_2}} / {{st2_ac_3}}ã€ãƒªãƒªãƒ¼ã‚¹: {{st2_release | default:"MVP"}}ï¼‰
        3. {{st3_summary}}ï¼ˆå—ã‘å…¥ã‚ŒåŸºæº–: {{st3_ac_1}} / {{st3_ac_2}} / {{st3_ac_3}}ã€ãƒªãƒªãƒ¼ã‚¹: {{st3_release | default:"Release1"}}ï¼‰
        
        ## å®Ÿè£…é †åº
        {{impl_order | default:"ST1â†’ST2â†’ST3"}}
    
    - name: "export_story_map_yaml"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map.yaml"
      content: |
        story_map:
          persona_ref: {{persona_id | default:"P001"}}
          problem_refs: [PR1, PR2, PR3]
          links:
            - chain: [A101, PR1, SL1, ST1]
            - chain: [A201, PR2, SL2, ST2]
            - chain: [A301, PR3, SL3, ST3]
          stories:
            - id: ST1
              summary: {{st1_summary}}
              acceptance: [{{st1_ac_1}}, {{st1_ac_2}}, {{st1_ac_3}}]
              release: {{st1_release | default:"MVP"}}
              links: [PR1, SL1, A101]
            - id: ST2
              summary: {{st2_summary}}
              acceptance: [{{st2_ac_1}}, {{st2_ac_2}}, {{st2_ac_3}}]
              release: {{st2_release | default:"MVP"}}
              links: [PR2, SL2, A201]
            - id: ST3
              summary: {{st3_summary}}
              acceptance: [{{st3_ac_1}}, {{st3_ac_2}}, {{st3_ac_3}}]
              release: {{st3_release | default:"Release1"}}
              links: [PR3, SL3, A301]
          releases:
            - name: MVP
              includes: [ST1, ST2]
            - name: Release1
              includes: [ST3]
          numbering_policy:
            - prefix: ST=Story
    
    - name: "export_story_map_mermaid"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_mermaid.md"
      content: |
        ```mermaid
        flowchart LR
          A101:::action --> PR1:::problem --> SL1:::solution --> ST1[ST1]:::story
          A201:::action --> PR2:::problem --> SL2:::solution --> ST2[ST2]:::story
          A301:::action --> PR3:::problem --> SL3:::solution --> ST3[ST3]:::story
          classDef action fill:#fff3e0
          classDef problem fill:#ffebee
          classDef solution fill:#e8f5e8
          classDef story fill:#e3f2fd
        ```
    
    - name: "notify_completion"
      action: "display"
      content: |
        âœ… ç”Ÿæˆã—ã¾ã—ãŸï¼š
        - 04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_proposed.yaml / story_map_proposed_mermaid.md
        - 04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_todo.md / story_map.yaml / story_map_mermaid.md
```

## æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰
â†’ `ä»®èª¬é§†å‹•_UIãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ` ã§ç”»é¢è¨­è¨ˆã¸
